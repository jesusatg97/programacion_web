<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">

        <!-- 3 líneas necesarias para el uso de OnsenUI --->
        <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
        <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
        <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="style.css"/>

        <title>Estacionamiento CUCEI </title>
    <body>
      <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgZb2NLQkbAqGr6NajCrJZkR4oSVsQo9E" type="text/javascript"></script>
      <script>
      function verificarExistente()
      {
            var cc = document.getElementById('codigo').value;
            var cn = document.getElementById('nombre').value;
            if(existeAlumno = true)
            {
              var my_php = //aqui iria la direccion php donde se hara el select para validar si existe el usuario.
              
            }
            else {
              capturaUsuario();
            }













      }

      ons.ready(function()
      {

      if(window.localStorage.length > 0)
      {
        var myNavigator = document.getElementById("myNavigator");
        myNavigator.pushPage("maps.html");
      }
      else {
       console.log("NO hay datos en LOCALSTORAGE");

     }

     });


      function compruebaDatos(str_placas, str_telefono) // función para comprobar la integridad de los datos capturados
      {
        var placas_good = false;
        var telefono_good = false;

        if(str_placas[3] == '-')
        {
          var cadena = str_placas.split('-');
          var p1 = cadena[0];
          var p2 = cadena[1];

          var primera = false;
          if(isNaN(p1[0]) && isNaN(p1[1]) && isNaN(p1[2]))
          {
            primera = true;
          }
          var segunda = isNaN(p2);

          if((primera) && (!segunda))
          {
            placas_good = true;
          }
        }
        // comprobando Teléfono
        if(!isNaN(str_telefono))
        {
          telefono_good = true;
        }

        console.log(placas_good+" "+telefono_good)
        if((placas_good) && (telefono_good))
        {
          return true;
        }
        else
        {
          return false;
        }
      };

      function salir()
      {
        window.localStorage.removeItem('nombre');
        window.localStorage.removeItem('codigo');
        //window.localStorage.removeItem('nip');
        window.localStorage.removeItem('placas');
        window.localStorage.removeItem('telefono');
        window.localStorage.removeItem('password');
        localStorage.clear();

        if(window.localStorage.length == 0)
        {
          var navegador = document.getElementById("myNavigator");
          navegador.pushPage("loginpage.html");
          localStorage.clear();

        }
        location.reload();

      };
      </script>

      <ons-page>
      </head>
      <body class="welcome">
    <span id="splash-overlay" class="splash"></span>
    <span id="welcome" class="z-depth-4"></span>
    <header>
      <center>



        <ons-navigator swipeable id="myNavigator" page="loginpage.html" animation="slide"></ons-navigator>

        <template id="loginpage.html"> <!-- página inicial de la app: login --->
          <ons-page id="main_page">
              <div class="center"><b>Estacionamiento CUCEI</b></div>
            <script>


              function capturaUsuario(data1, data2)
              {
                var cc = data1;
                var cn = data2;
                var placas = prompt("Ingrese:\n Placas: ", "");
                var telefono = prompt(" Ingrese Su\n Teléfono: ", "");

                placas = placas.toUpperCase();
                window.localStorage.setItem('codigo', cc);
                window.localStorage.setItem('nombre', cn);
                window.localStorage.setItem('placas', placas);
                window.localStorage.setItem('telefono', telefono);
                var captura_correcta = compruebaDatos(placas, telefono);
                if(captura_correcta)
                {
                  var capture_url = "http://cuceimobile.tech/Escuela/altaU.php?codigo="+cc+"&nombre="+cn+"&placas="+placas+"&telefono="+telefono;
                  var xhttp2 = new XMLHttpRequest;
                  xhttp2.onreadystatechange = function()
                  {
                    console.log(xhttp2.responseText);
                  };
                  xhttp2.open("GET", capture_url, true); xhttp2.send();
                  ons.notification.alert("Captura exitosa!");
                  map_title = cn;
                  var navegador = document.getElementById("myNavigator");
                  navegador.pushPage("maps.html");
                }
                else
                {
                  ons.notification.alert("Parece haber un problema con tus datos.\n comprobar datos validos de placas."
                                +"\n TELÉFONO invalido: Solo se aceptan números.");
                }
              };
              // programando el evento "onclick" del botón ENTRAR
              document.getElementById("LoginBttn").onclick = function()
              {
                var existeAlumno = false;

                if(document.getElementById("input_codigo").value == "	" || document.getElementById("input_passwd").value == "")
                {
                  ons.notification.alert(" Campos incompletos. Verifica e intenta de nuevo.");
                }
                else
                {
                  console.log("Iniciando sesión");
                  var c = document.getElementById("input_codigo").value;
                  var p = document.getElementById("input_passwd").value;

                  // iniciando el login
                  var url = "https://dcc.000webhostapp.com/2018/datosudeg.php?codigo="+c+"&nip="+p;
                  var xhttp = new XMLHttpRequest;
                  xhttp.onreadystatechange = function()
                  {
                    if(this.readyState == 4 && this.status == 200)
                    {

                      var cadena_respuesta = xhttp.responseText;
                      var arreglo = [];
                      arreglo = cadena_respuesta.split(',');

                      if(arreglo.length > 1)
                      {
                        existeAlumno = true;
                      }

                      if(!existeAlumno)
                      {
                        ons.notification.alert(" Datos incorrectos.");
                        document.getElementById("input_codigo").value = "";
                        document.getElementById("input_passwd").value = "";
                      }
                      else
                      {
                        //ons.notification.alert(" Bienvenido! "+arreglo[2]);
                        //console.log(" Mostrando popup con entradas para capturar los datos del vehículo . . .");
                        //window.localStorage.setItem('nip', p);
                        console.log("arreglos", arreglo[1], arreglo[2])
                        capturaUsuario(arreglo[1], arreglo[2]);
                      }
                    }
                  };
                  xhttp.open("GET", url, true); xhttp.send();
                }
              };

              // programando el evento "onclick" del botón NUEVO
              document.getElementById("NuevoBttn").onclick = function()
              {
                console.log("Creando usuario visitante . . .");

                var navegador = document.getElementById("myNavigator");
                navegador.pushPage("nuevoUsuario.html");
              };

            var showTemplateDialog = function() {
            var dialog = document.getElementById('my-dialog');

           if (dialog) {
           dialog.show();
          } else {
         ons.createElement('dialog.html', { append: true })
           .then(function(dialog) {
        dialog.show();
      });
  }
};

var hideDialog = function(id) {
  document
    .getElementById(id)
    .hide();
};



            </script>
          </head>
            <body class="welcome">
          <span id="splash-overlay" class="splash"></span>
          <span id="welcome" class="z-depth-4"></span>

            <br>
            <img src="Mercedes_Benz_Logo_11.jpg"  alt="Est" width="150" height="90">

            </p>
            <ons-input input-id="input_codigo" type="number" placeholder="Código" modifier="underbar"></ons-input> </p>
            <ons-input input-id="input_passwd" type="password" placeholder="Contraseña" modifier="underbar"></ons-input>

            </p>
            <ons-button id="LoginBttn" style="background-color: green">Entrar</ons-button>


            <ons-button id="NuevoBttn" style="background-color: green"> Nuevo Usuario</ons-button>
          </ons-page>
        </template>

        <template id="nuevoUsuario.html"> <!-- página de nuevo usuario/visitante --->
          <ons-page id="nuevo_page">
            <ons-toolbar>
              <div class="center"><b>Registro Nvo Usuario</b></div>
            </ons-toolbar>

            <script>

            function generaCodigoVisitante()
            {
              var numero;
              var numero_str = "";
              var cifra=[];
              for(a=0; a<9; a++)
              {
              	cifra[a]=parseInt(Math.random()*10);
              	if(a==0)
                {
              		cifra[a]=parseInt(Math.random()*9)+1;
              	}
              	for(aa=0;aa<a;aa++)
                {
              		if(cifra[a]==cifra[aa]){a-=1;break}
              	}
              }
              for(a=0;a<9;a++)
              {
              	numero_str+=cifra[a];
              }
              numero = parseInt(numero_str);

              return numero;

            }

            function capturaVisitante(data1, data2, data3, data4, data5)
            {
              var cc = data1;
              var cn = data2;
              var placas = data3;
              var telefono = data4;
              var pass = data5;

              window.localStorage.setItem('codigo', cc);
              window.localStorage.setItem('nombre', cn);
              window.localStorage.setItem('placas',placas);
              window.localStorage.setItem('telefono',telefono);
              window.localStorage.setItem('password',pass);

              var capture_url = "http://cuceimobile.tech/Escuela/altaU.php?codigo="+cc+"&nombre="+cn+"&placas="+placas+"&telefono="+telefono+"&password="+pass;
              var xhttp2 = new XMLHttpRequest;
              xhttp2.onreadystatechange = function()
              {
                console.log(xhttp2.responseText);
              };
              xhttp2.open("GET", capture_url, true); xhttp2.send();
            }

              var numVisitante = generaCodigoVisitante();
              document.getElementById("label_codigov").innerHTML = numVisitante;

              document.getElementById("AltaVBttn").onclick = function() // función del evento onclick, botón para dar de alta al visitante
              {
                if(document.getElementById("input_nombrev").value == "" ||
                   document.getElementById("input_placasv").value == "" ||
                   document.getElementById("input_telefonov").value == "" ||
                   document.getElementById("input_passwdv").value == "")
                  {
                    ons.notification.alert(" Campos incompletos, Verifica e intentalo de nuevo.");
                  }
                else
                {
                  var vc = numVisitante;
                  var vn = document.getElementById("input_nombrev").value;
                  var vp = document.getElementById("input_placasv").value ;
                  var vt = document.getElementById("input_telefonov").value;
                  var vps = document.getElementById("input_passwdv").value;



                  vp = vp.toUpperCase(); vn = vn.toUpperCase();
                  var captura_correcta = compruebaDatos(vp, vt); // comprobando formatos de la placa y teléfono
                  if(captura_correcta)
                  {
                    capturaVisitante(vc, vn, vp, vt, vps);
                    ons.notification.alert("Captura exitosa!");
                    map_title = window.localStorage.getItem('nombre');
                    var navegador = document.getElementById("myNavigator");
                    navegador.pushPage("maps.html"); // damos de alta y pasamos al maps
                  }
                  else
                  {
                    window.alert("Parece haber un problema con tus datos.\n comprueba las placas"
                                  +"\n TELÉFONO invalido: Solo se aceptan números."); // mostramos los formatos correctos para evitar el siguiente error
                  }
                }
              };
              //en este punto del codigo es donde al validar que ya estan nuestros datos guardados en localStorage nos redireccionara al mapa de google.



              // programando el evento "onclick" del botón ENTRAR
              document.getElementById("LoginBttn").onclick = function()
              {
                var existeAlumno = false;

                if(document.getElementById("input_codigo").value == "	" || document.getElementById("input_passwd").value == "")
                {
                  ons.notification.alert(" Campos incompletos. Verifica e intenta de nuevo.");
                }
                else
                {
                  console.log("Iniciando sesión . . .");
                  var c = document.getElementById("input_codigo").value;
                  var p = document.getElementById("input_passwd").value;

                  // iniciando el login
                  var url = "https://dcc.000webhostapp.com/2018/datosudeg.php?codigo="+c+"&nip="+p;
                  var xhttp = new XMLHttpRequest;
                  xhttp.onreadystatechange = function()
                  {
                    if(this.readyState == 4 && this.status == 200)
                    {

                      var cadena_respuesta = xhttp.responseText;
                      var arreglo = [];
                      arreglo = cadena_respuesta.split(',');

                      if(arreglo.length > 1)
                      {
                        existeAlumno = true;
                      }

                      if(!existeAlumno)
                      {
                        ons.notification.alert(" Datos incorrectos.");
                        document.getElementById("input_codigo").value = "";
                        document.getElementById("input_passwd").value = "";
                      }
                      else
                      {
                        //ons.notification.alert(" Bienvenido! "+arreglo[2]);
                        //console.log(" Mostrando popup con entradas para capturar los datos del vehículo . . .");
                        //window.localStorage.setItem("nip", p);
                        console.log("arreglos", arreglo[1], arreglo[2])
                        capturaUsuario(arreglo[1], arreglo[2]);
                      }
                    }
                  };
                  xhttp.open("GET", url, true); xhttp.send();
                }
              };




            </script>

            </p>
            <b> CÓDIGO: <label id="label_codigov"> </label> </b> </p>
            <ons-input input-id="input_nombrev" type="responseText" placeholder="Nombre" modifier="underbar"></ons-input> </p>
            <ons-input input-id="input_placasv" type="text" placeholder="Placas" modifier="underbar"></ons-input> </p>
            <ons-input input-id="input_telefonov" type="number" placeholder="Teléfono" modifier="underbar"></ons-input> </p>
            <ons-input input-id="input_passwdv" type="password" placeholder="Contraseña" modifier="underbar"></ons-input> </p>

            <ons-button id="AltaVBttn" style="background-color: green">Registrar nuevo</ons-button>
          </ons-page>
        </template>

        <template id="maps.html"> <!-- página de nuevo usuario/visitante --->
          <ons-page id="map_page">
            <script>
            setTimeout(function()
            {


                     var header_map = window.localStorage.getItem('nombre');
                    map = new google.maps.Map(document.getElementById("map"),
                    { center: {lat: 20.655036, lng: -103.325131}, zoom: 175 });
                    document.getElementById("map_label").innerHTML = "<b>"+header_map+"</b>";





            },4000);


            setTimeout();

            </script>
            <ons-toolbar>
              <div id="map_label" class="center"><b></b></div>
             </ons-toolbar>
              <ons-button id="pushbutton" onclick="salir()">Salir</ons-button>
            <style>
              #map {
                height: 100%;
              }
              html, body {
                height: 100%;
                margin: 0;
                padding: 0;
              }
            </style>

            <script>
               var header_map = window.localStorage.getItem('nombre');
              map = new google.maps.Map(document.getElementById("map"),
              { center: {lat: 20.655036, lng: -103.325131}, zoom: 175 });
              document.getElementById("map_label").innerHTML = "<b>"+header_map+"</b>";
            </script>

            <div id="map"></div>

          </ons-page>
        </template>
<template id="dialog.html">
  <ons-dialog id="my-dialog">
    <div style="text-align: center; padding: 10px;">
      <p>
      Placas:
      <ons-input id="placas" type="text" modifier="underbar"></ons-input>
      <br>
      <ons-input id="telefono" type="text" modifier="underbar"></ons-imput>
      <br>

      </p>

      <p>
        <!---<ons-button onclick="LoginBttn"> Entrar</ons-button>--->
        <ons-button onclick="hideDialog('my-dialog')">Close</ons-button>
      </p>
    </div>
  </ons-dialog>
</template>

      </center>
      </ons-page>
    </header>
    </body>
<!-- <cap -->

</html>
